<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Customer Tasks & Leads (with CSV Upload)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020; --panel:#121a35; --panel2:#0f1530; --text:#eaf0ff; --muted:#aab4d6;
      --border:#1f2a4f; --accent:#5b8cff; --accent2:#74d680; --warn:#ffcc66; --danger:#ff6b6b; --mark:#fff2a8;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:linear-gradient(180deg,#0a0f1f 0%, #0e1430 100%); color:var(--text)}
    header{position:sticky; top:0; z-index:10; padding:16px; border-bottom:1px solid var(--border); background:rgba(13,18,40,.7); backdrop-filter:blur(6px) saturate(140%)}
    .container{max-width:1100px; margin:18px auto; padding:0 14px}
    h1{margin:0; font-size:20px}
    .sub{margin-top:4px; color:var(--muted); font-size:13px}
    .toolbar{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input[type="text"], input[type="date"], textarea, select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0b1433; color:#eaf0ff; outline:none;
    }
    textarea{min-height:90px}
    .btn{appearance:none; border:none; border-radius:10px; padding:9px 13px; color:#fff; font-weight:600; cursor:pointer; transition:.15s transform ease, .2s background ease}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg, var(--accent) 0%, #3f69ff 100%)}
    .btn.secondary{background:#1a2446; border:1px solid var(--border); color:#dfe7ff}
    .btn.ok{background:linear-gradient(180deg, var(--accent2) 0%, #3fbf74 100%)}
    .btn.warn{background:linear-gradient(180deg, var(--warn) 0%, #f5b24e 100%); color:#2a1b05}
    .btn.danger{background:linear-gradient(180deg, var(--danger) 0%, #ff5252 100%)}
    .btn.sm{padding:6px 10px; font-size:12px}
    .tabs{display:flex; gap:8px; margin-top:14px; flex-wrap:wrap}
    .tab{padding:8px 12px; border-radius:10px; background:#121a35; border:1px solid var(--border); color:#cdd7ff; cursor:pointer; font-weight:700}
    .tab.active{background:#1b2552}
    .card{background:linear-gradient(180deg,var(--panel) 0%, var(--panel2) 100%); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .filters{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px}
    .chip{padding:7px 12px; background:#121a35; border:1px solid var(--border); border-radius:999px; color:#cfe1ff; font-weight:700; cursor:pointer; font-size:12px; user-select:none}
    .chip.active{background:#1b2552}
    .list{margin-top:10px; border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .row{display:flex; gap:12px; align-items:center; padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer}
    .row:last-child{border-bottom:none}
    .row .meta{flex:1}
    .muted{color:var(--muted); font-size:12px}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; font-weight:800}
    .p-pending{background:#20305f; color:#7fb1ff}
    .p-inprog{background:#4a2b05; color:#ffb067}
    .p-onhold{background:#2e1f44; color:#c79bff}
    .p-cancel{background:#313842; color:#9bb0c4}
    .p-due{background:#372a12; color:#ffd27e}
    .p-overdue{background:#3a1212; color:#ff9a9a}
    .p-complete{background:#173726; color:#87e2a5}
    .hidden{display:none}
    .hr{height:1px; background:var(--border); margin:12px 0}
    .inline{display:flex; gap:8px; align-items:center}
    .wrap{flex-wrap:wrap}
    .grow{flex:1}
    .right{margin-left:auto}
    .small{font-size:12px}
    mark{background:var(--mark); color:#000; padding:0 2px; border-radius:4px}
    /* Toasts */
    #toaster{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:9999}
    .toast{min-width:260px; max-width:420px; padding:10px 12px; border-radius:10px; color:#fff; font-weight:600; box-shadow:0 10px 20px rgba(0,0,0,.25)}
    .toast.info{background:#2b4a9e}
    .toast.success{background:#2a7a47}
    .toast.error{background:#a33a3a}
    .toast button{background:transparent; border:none; color:#fff; margin-left:8px; cursor:pointer; font-weight:800}
    @keyframes flash { 0%{box-shadow:0 0 0 0 rgba(91,140,255,.9)} 100%{box-shadow:0 0 0 12px rgba(91,140,255,0)} }
    .flash { position:relative; animation:flash 1s ease-out 0s 1; border-color:#5b8cff !important; background:linear-gradient(180deg,#13204a 0%, #0f1738 100%); }
  </style>
</head>
<body>
  <header>
    <h1>Customer Tasks & Leads</h1>
    <div class="sub">Tap a task row to open; tap its status pill to cycle.</div>
    <div class="toolbar">
      <button class="btn secondary" onclick="window.CT && CT.exportCSV()">Export CSV</button>
      <button class="btn secondary" onclick="window.CT && CT.backupJSON()">Backup</button>
      <button class="btn primary"   onclick="window.CT && CT.openAdd()">Add Task</button>

      <!-- CSV Target + Upload (wired in JS too) -->
      <select id="csvTarget" class="btn secondary" style="padding:9px 10px">
        <option value="customers">Upload CSV → Customers</option>
        <option value="tasks">Upload CSV → Tasks</option>
        <option value="leads">Upload CSV → Leads</option>
      </select>
      <button class="btn secondary" id="btnCsvUpload">Choose CSV</button>
      <input id="csvFile" type="file" accept=".csv,text/csv" hidden />
    </div>
    <div class="tabs">
      <div id="tabActive"   class="tab active" onclick="window.CT && CT.switchTab('Active')">Active <span id="countActive" class="small"></span></div>
      <div id="tabCompleted" class="tab"       onclick="window.CT && CT.switchTab('Completed')">Completed <span id="countCompleted" class="small"></span></div>
      <div id="tabLeads"     class="tab"       onclick="window.CT && CT.switchTab('Leads')">Leads <span id="countLeads" class="small"></span></div>
    </div>
  </header>

  <div class="container">
    <!-- Tasks: Active -->
    <div id="activeView">
      <div class="card">
        <div class="filters">
          <button data-filter="Pending" class="chip active">Pending</button>
          <button data-filter="In Progress" class="chip">In Progress</button>
          <button data-filter="On Hold" class="chip">On Hold</button>
          <button data-filter="Cancelled" class="chip">Cancelled</button>
          <div class="right muted">Overdue tasks show <span class="pill p-overdue">Overdue</span></div>
        </div>
        <div id="activeList" class="list"></div>
      </div>
    </div>

    <!-- Tasks: Completed -->
    <div id="completedView" class="hidden">
      <div class="card">
        <div class="filters">
          <span class="muted">These tasks are archived. Open a row to change status if needed.</span>
        </div>
        <div id="completedList" class="list"></div>
      </div>
    </div>

    <!-- Leads -->
    <div id="leadsView" class="hidden">
      <div class="card">
        <div class="filters">
          <button id="addLeadBtn" class="btn primary sm">Add Lead</button>
          <span class="right"></span>
          <span class="muted">Filter:</span>
          <button class="chip lead-filter active" data-leadfilter="All">All</button>
          <button class="chip lead-filter" data-leadfilter="Talked">Talked</button>
          <button class="chip lead-filter" data-leadfilter="Interested">Interested</button>
          <button class="chip lead-filter" data-leadfilter="Waiting Confirmation">Waiting</button>
          <button class="chip lead-filter" data-leadfilter="Converted">Converted</button>
        </div>
        <div id="leadsList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div id="taskModal" class="hidden" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:50">
    <div class="card" style="width:min(980px,96vw); max-height:92vh; overflow:auto">
      <h3 id="taskModalTitle" style="margin:0 0 10px 0">Add Task</h3>

      <div class="inline wrap" style="gap:16px">
        <div class="grow">
          <label>Customer Name</label>
          <input id="taskCustomerName" type="text" placeholder="Type name (new or existing)" />
        </div>
        <div class="grow">
          <label>Customer Mobile(s)</label>
          <input id="taskCustomerMobile" type="text" placeholder="Any number(s), comma-separated for multiple" />
        </div>
      </div>
      <div class="small muted" id="taskCustomerMeta" style="margin-top:6px">
        Tip: Type a new name + any number(s). A new customer will be created if needed.
      </div>

      <div class="hr"></div>
      <div class="inline wrap" style="gap:16px; margin-top:10px">
        <div class="grow">
          <label>Task Description</label>
          <textarea id="taskDesc" placeholder="What needs to be done?"></textarea>
        </div>
        <div style="min-width:240px; flex:1">
          <label>Due Date</label>
          <input id="taskDue" type="date" />
          <div class="hr"></div>
          <label>Status</label>
          <select id="taskStatus">
            <option>Pending</option>
            <option>In Progress</option>
            <option>On Hold</option>
            <option>Cancelled</option>
            <option>Completed</option>
          </select>
          <div class="small muted" style="margin-top:6px">Completed tasks move to the Completed tab.</div>
        </div>
      </div>

      <div class="inline wrap sticky-footer" style="gap:8px; margin-top:10px; position:sticky; bottom:0; background:linear-gradient(180deg,#0f1738 0%, #0e1430 100%); border-top:1px solid var(--border); padding-top:10px">
        <div class="inline" style="gap:8px">
          <button id="saveTaskBtn" class="btn ok">Save</button>
          <button id="cancelTaskBtn" class="btn secondary">Cancel</button>
        </div>
        <div class="right small muted" id="taskTimestamps"></div>
      </div>
    </div>
  </div>

  <!-- Lead Modal -->
  <div id="leadModal" class="hidden" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:50">
    <div class="card" style="width:min(980px,96vw); max-height:92vh; overflow:auto">
      <h3 id="leadModalTitle" style="margin:0 0 10px 0">Add Lead</h3>

      <div class="inline wrap" style="gap:16px">
        <div class="grow">
          <label>Customer Name</label>
          <input id="leadName" type="text" placeholder="Name" />
        </div>
        <div class="grow">
          <label>Customer Mobile(s)</label>
          <input id="leadNumbers" type="text" placeholder="Any number(s), comma-separated" />
        </div>
      </div>

      <div class="inline wrap" style="gap:16px; margin-top:10px">
        <div class="grow">
          <label>Product</label>
          <input id="leadProduct" type="text" placeholder="Product name" />
        </div>
        <div style="min-width:240px; flex:1">
          <label>Status</label>
          <select id="leadStatus">
            <option>Talked</option>
            <option>Interested</option>
            <option>Waiting Confirmation</option>
            <option>Converted</option>
          </select>
        </div>
      </div>

      <div class="inline wrap" style="gap:16px; margin-top:10px">
        <div class="grow">
          <label>Lead Description</label>
          <textarea id="leadDesc" placeholder="Notes about this lead (context, requirements, follow-ups, etc.)"></textarea>
        </div>
      </div>

      <div class="inline wrap sticky-footer" style="gap:8px; margin-top:10px; position:sticky; bottom:0; background:linear-gradient(180deg,#0f1738 0%, #0e1430 100%); border-top:1px solid var(--border); padding-top:10px">
        <div class="inline" style="gap:8px">
          <button id="saveLeadBtn" class="btn ok">Save</button>
          <button id="cancelLeadBtn" class="btn secondary">Cancel</button>
        </div>
        <div class="right inline" style="gap:8px">
          <button id="deleteLeadBtn" class="btn danger hidden">Delete</button>
          <div class="small muted" id="leadTimestamps"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toaster"></div>

  <script>
  (function(){
    'use strict';
    const CT = window.CT = window.CT || {};
    CT.__loaded = true;

    /* ===== Utils ===== */
    const q = sel => document.querySelector(sel);
    const qAll = sel => Array.from(document.querySelectorAll(sel));
    const nowISO = () => new Date().toISOString();
    const fmtDate = d => d ? new Date(d).toLocaleString() : "";
    const escapeHtml = s => String(s??"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c] || c));
    const uuid = ()=> ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16));

    /* ===== Toasts ===== */
    const elToaster = q('#toaster');
    function showToast(type, msg, ms=3000){
      try{
        if(!elToaster){ alert(msg); return; }
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = `<span>${escapeHtml(msg)}</span><button onclick="this.parentElement.remove()">✕</button>`;
        elToaster.appendChild(el);
        setTimeout(()=>{ el.remove(); }, ms);
      }catch(e){ console.error('Toast error', e); }
    }

    /* ===== Persistence ===== */
    const LS_CUSTOMERS = "ct_customers_v1";
    const LS_TASKS = "ct_tasks_v1";
    const LS_LEADS = "ct_leads_v1";
    let customers = loadJSON(LS_CUSTOMERS, []);
    let tasks = loadJSON(LS_TASKS, []);
    let leads = loadJSON(LS_LEADS, []);
    function loadJSON(key, fallback){
      try{ const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback; }
      catch(e){ console.warn('loadJSON', e); return fallback; }
    }
    function saveAll(){
      try{
        localStorage.setItem(LS_CUSTOMERS, JSON.stringify(customers));
        localStorage.setItem(LS_TASKS, JSON.stringify(tasks));
        localStorage.setItem(LS_LEADS, JSON.stringify(leads));
        render();
      }catch(e){ console.error('saveAll', e); }
    }

    /* ===== State ===== */
    const STATUS = {
      PENDING: "Pending",
      INPROG: "In Progress",
      ONHOLD: "On Hold",
      CANCELLED: "Cancelled",
      COMPLETED: "Completed",
    };
    const LEAD_STATUS = ["Talked","Interested","Waiting Confirmation","Converted"];
    let activeTab = "Active";
    let activeFilter = STATUS.PENDING;
    let leadFilter = "All";

    /* ===== DOM refs ===== */
    const elActiveView = q("#activeView");
    const elCompletedView = q("#completedView");
    const elLeadsView = q("#leadsView");
    const elActiveList = q("#activeList");
    const elCompletedList = q("#completedList");
    const elLeadsList = q("#leadsList");

    function isOverdue(t){
      if(!t.dueDate || t.status===STATUS.COMPLETED) return false;
      const today = new Date(); today.setHours(0,0,0,0);
      const due = new Date(t.dueDate); due.setHours(0,0,0,0);
      return due < today;
    }
    function pillClass(status){
      switch(status){
        case STATUS.PENDING: return "p-pending";
        case STATUS.INPROG: return "p-inprog";
        case STATUS.ONHOLD: return "p-onhold";
        case STATUS.CANCELLED: return "p-cancel";
        case STATUS.COMPLETED: return "p-complete";
        default: return "p-pending";
      }
    }
    function render(){
      try{
        q("#countActive").textContent = `(${tasks.filter(t=>t.status!==STATUS.COMPLETED).length})`;
        q("#countCompleted").textContent = `(${tasks.filter(t=>t.status===STATUS.COMPLETED).length})`;
        q("#countLeads").textContent = `(${leads.length})`;
        elActiveView.classList.toggle("hidden", activeTab!=="Active");
        elCompletedView.classList.toggle("hidden", activeTab!=="Completed");
        elLeadsView.classList.toggle("hidden", activeTab!=="Leads");
        if(activeTab==="Active") renderActive();
        else if(activeTab==="Completed") renderCompleted();
        else renderLeads();
      }catch(e){ console.error('render', e); }
    }
    function renderActive(){
      elActiveList.innerHTML = "";
      let pool = tasks.filter(t => t.status !== STATUS.COMPLETED);
      if([STATUS.PENDING, STATUS.INPROG, STATUS.ONHOLD, STATUS.CANCELLED].includes(activeFilter)){
        pool = pool.filter(t => t.status === activeFilter);
      }
      pool.sort((a,b)=> new Date(b.updatedAt||b.createdAt) - new Date(a.updatedAt||a.createdAt));
      if(pool.length===0){
        elActiveList.innerHTML = `<div class="row"><div class="meta">No active tasks.</div><button class="btn primary sm" onclick="CT.openAdd()">Add Task</button></div>`;
        return;
      }
      for(const t of pool){
        const c = customers.find(c=>c.id===t.customerId);
        const name = c ? (c.name||"Unknown") : "(missing)";
        const overdue = isOverdue(t);
        const row = document.createElement("div");
        row.className = "row";
        row.dataset.taskId = t.id;
        row.tabIndex = 0;
        row.innerHTML = `
          <div class="meta">
            <div class="inline wrap">
              <strong>${escapeHtml(name)}</strong>
              <span class="pill ${pillClass(t.status)} status-pill" data-id="${t.id}" title="Tap to cycle status" style="margin-left:8px">${t.status}</span>
              ${t.dueDate ? `<span class="pill ${overdue? 'p-overdue':'p-due'}" style="margin-left:8px">${overdue? 'Overdue:':'Due:'} ${t.dueDate}</span>` : ""}
            </div>
            <div class="muted small" style="margin-top:4px">${escapeHtml(t.description||"(no description)")} • Created: ${fmtDate(t.createdAt)} • Updated: ${fmtDate(t.updatedAt)}</div>
          </div>
        `;
        elActiveList.appendChild(row);
      }
    }
    function renderCompleted(){
      elCompletedList.innerHTML = "";
      let pool = tasks.filter(t => t.status === STATUS.COMPLETED);
      pool.sort((a,b)=> new Date(b.updatedAt||b.createdAt) - new Date(a.updatedAt||a.createdAt));
      if(pool.length===0){
        elCompletedList.innerHTML = `<div class="row"><div class="meta">No completed tasks.</div></div>`;
        return;
      }
      for(const t of pool){
        const c = customers.find(c=>c.id===t.customerId);
        const name = c ? (c.name||"Unknown") : "(missing)";
        const row = document.createElement("div");
        row.className = "row";
        row.dataset.taskId = t.id;
        row.tabIndex = 0;
        row.innerHTML = `
          <div class="meta">
            <div class="inline wrap">
              <strong>${escapeHtml(name)}</strong>
              <span class="pill p-complete" title="Completed" style="margin-left:8px">Completed</span>
              ${t.dueDate ? `<span class="pill p-due" style="margin-left:8px">Was Due: ${t.dueDate}</span>` : ""}
            </div>
            <div class="muted small" style="margin-top:4px">${escapeHtml(t.description||"(no description)")} • Created: ${fmtDate(t.createdAt)} • Updated: ${fmtDate(t.updatedAt)}</div>
          </div>
        `;
        elCompletedList.appendChild(row);
      }
    }
    function renderLeads(){
      elLeadsList.innerHTML = "";
      let pool = leads.slice();
      if (leadFilter!=="All") pool = pool.filter(l=>l.status===leadFilter);
      pool.sort((a,b)=> new Date(b.updatedAt||b.createdAt) - new Date(a.updatedAt||a.createdAt));
      if (pool.length===0){
        elLeadsList.innerHTML = `<div class="row"><div class="meta">No leads${leadFilter!=="All"?" in "+leadFilter:""}.</div><button class="btn primary sm" onclick="CT.openLeadAdd()">Add Lead</button></div>`;
        return;
      }
      for(const l of pool){
        const row = document.createElement("div");
        row.className = "row";
        row.dataset.leadId = l.id;
        row.tabIndex = 0;
        row.innerHTML = `
          <div class="meta">
            <div class="inline wrap">
              <strong>${escapeHtml(l.name||"(unnamed)")}</strong>
              <span class="pill ${leadPillClass(l.status)} lead-status" data-id="${l.id}" title="Tap to cycle status" style="margin-left:8px">${l.status}</span>
              ${l.product ? `<span class="pill p-due" style="margin-left:8px">Product: ${escapeHtml(l.product)}</span>` : ""}
            </div>
            <div class="muted small" style="margin-top:4px">Created: ${fmtDate(l.createdAt)} • Updated: ${fmtDate(l.updatedAt)}</div>
            ${l.description ? `<div class="muted small" style="margin-top:4px">${escapeHtml(l.description)}</div>` : ""}
          </div>
        `;
        elLeadsList.appendChild(row);
      }
    }
    function leadPillClass(s){
      switch(s){
        case "Talked": return "p-pending";
        case "Interested": return "p-inprog";
        case "Waiting Confirmation": return "p-onhold";
        case "Converted": return "p-complete";
        default: return "p-pending";
      }
    }

    /* ===== Tabs & Filters ===== */
    CT.switchTab = function(which){
      activeTab = which;
      q("#tabActive").classList.toggle("active", which==="Active");
      q("#tabCompleted").classList.toggle("active", which==="Completed");
      q("#tabLeads").classList.toggle("active", which==="Leads");
      render();
    };
    qAll('.filters .chip[data-filter]').forEach(ch=>{
      ch.addEventListener("click", ()=>{
        qAll('.filters .chip[data-filter]').forEach(x=>x.classList.remove("active"));
        ch.classList.add("active");
        activeFilter = ch.getAttribute("data-filter");
        render();
      });
    });
    qAll('.lead-filter').forEach(ch=>{
      ch.addEventListener("click", ()=>{
        qAll('.lead-filter').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
        leadFilter = ch.getAttribute('data-leadfilter');
        renderLeads();
      });
    });

    /* ===== Task Modal ===== */
    const elTaskModal = q("#taskModal");
    const elTaskModalTitle = q("#taskModalTitle");
    const elTaskCustomerName = q("#taskCustomerName");
    const elTaskCustomerMobile = q("#taskCustomerMobile");
    const elTaskCustomerMeta = q("#taskCustomerMeta");
    const elTaskDesc = q("#taskDesc");
    const elTaskDue = q("#taskDue");
    const elTaskStatus = q("#taskStatus");
    const elSaveTaskBtn = q("#saveTaskBtn");
    const elCancelTaskBtn = q("#cancelTaskBtn");
    const elTaskTimestamps = q("#taskTimestamps");

    let editingTaskId = null;
    let editingTaskCustomerId = null;

    function openTaskModal(customerId=null, taskId=null){
      editingTaskId = taskId;
      editingTaskCustomerId = customerId;

      if(taskId){
        const t = tasks.find(x=>x.id===taskId);
        const c = customers.find(x=>x.id===t.customerId);
        elTaskModalTitle.textContent = "Edit Task";
        elTaskCustomerName.value = c?.name || "";
        elTaskCustomerMobile.value = (c?.numbers || []).join(", ");
        elTaskCustomerMeta.textContent = c ? `Existing customer • Created: ${fmtDate(c.createdAt)} • Updated: ${fmtDate(c.updatedAt)}` : "";
        elTaskDesc.value = t.description || "";
        elTaskDue.value = t.dueDate || "";
        elTaskStatus.value = t.status || STATUS.PENDING;
        elTaskTimestamps.textContent = `Created: ${fmtDate(t.createdAt)} • Updated: ${fmtDate(t.updatedAt)}`;
      }else{
        elTaskModalTitle.textContent = "Add Task";
        elTaskCustomerName.value = "";
        elTaskCustomerMobile.value = "";
        elTaskCustomerMeta.textContent = "Tip: Type name + any number(s).";
        elTaskDesc.value = "";
        elTaskDue.value = "";
        elTaskStatus.value = STATUS.PENDING;
        elTaskTimestamps.textContent = "";
      }
      elTaskModal.style.display = "flex";
      setTimeout(()=>elTaskCustomerName.focus(), 0);
    }
    function closeTaskModal(){ elTaskModal.style.display = "none"; }

    elSaveTaskBtn.addEventListener("click", ()=>{
      try{
        const name = (elTaskCustomerName.value||"").trim();
        const numbersRaw = (elTaskCustomerMobile.value||"").split(",").map(s=>s.trim()).filter(Boolean);
        const desc = elTaskDesc.value.trim();
        const due = elTaskDue.value || "";
        const st = elTaskStatus.value;
        if (!name && numbersRaw.length===0){ showToast('error','Enter name or at least one number'); return; }
        let customer = null;
        if(editingTaskCustomerId){
          customer = customers.find(c=>c.id===editingTaskCustomerId) || null;
        }
        if(!customer && name){
          customer = customers.find(c=> (c.name||"") === name) || null;
        }
        if(!customer && numbersRaw.length){
          const flat = new Set(numbersRaw);
          customer = customers.find(c => (c.numbers||[]).some(m => flat.has(m))) || null;
        }
        if(!customer){
          customer = { id: uuid(), name, numbers: numbersRaw.slice(), createdAt: nowISO(), updatedAt: nowISO() };
          customers.push(customer);
        }else{
          const exist = new Set((customer.numbers||[]).map(x=>x.trim()).filter(Boolean));
          for(const n of numbersRaw){ if(n && !exist.has(n)){ customer.numbers.push(n); exist.add(n); } }
          customer.updatedAt = nowISO();
        }
        let newId = editingTaskId;
        if(editingTaskId){
          const t = tasks.find(x=>x.id===editingTaskId);
          t.customerId = customer.id;
          t.description = desc;
          t.dueDate = due;
          t.status = st;
          t.updatedAt = nowISO();
        }else{
          newId = uuid();
          tasks.push({ id: newId, customerId: customer.id, description: desc, dueDate: due, status: st, createdAt: nowISO(), updatedAt: nowISO() });
        }
        saveAll();
        closeTaskModal();
        showToast('success','Task saved');
      }catch(e){ console.error('save task', e); showToast('error','Could not save task'); }
    });
    elCancelTaskBtn.addEventListener("click", closeTaskModal);

    CT.openAdd = ()=> openTaskModal(null, null);
    CT.editTask = (id)=>{ const t = tasks.find(x=>x.id===id); if(t) openTaskModal(t.customerId, id); };

    /* ===== Leads Modal ===== */
    const elLeadModal = q("#leadModal");
    const elLeadModalTitle = q("#leadModalTitle");
    const elLeadName = q("#leadName");
    const elLeadNumbers = q("#leadNumbers");
    const elLeadProduct = q("#leadProduct");
    const elLeadStatus = q("#leadStatus");
    const elLeadDesc = q("#leadDesc");
    const elSaveLeadBtn = q("#saveLeadBtn");
    const elCancelLeadBtn = q("#cancelLeadBtn");
    const elDeleteLeadBtn = q("#deleteLeadBtn");
    const elLeadTimestamps = q("#leadTimestamps");
    let editingLeadId = null;

    function openLeadModal(leadId=null){
      editingLeadId = leadId;
      if (leadId){
        const l = leads.find(x=>x.id===leadId);
        elLeadModalTitle.textContent = "Edit Lead";
        elLeadName.value = l?.name || "";
        elLeadNumbers.value = (l?.numbers||[]).join(", ");
        elLeadProduct.value = l?.product || "";
        elLeadStatus.value = l?.status || "Talked";
        elLeadDesc.value = l?.description || "";
        elLeadTimestamps.textContent = `Created: ${fmtDate(l.createdAt)} • Updated: ${fmtDate(l.updatedAt)}`;
        elDeleteLeadBtn.classList.remove('hidden');
      }else{
        elLeadModalTitle.textContent = "Add Lead";
        elLeadName.value = "";
        elLeadNumbers.value = "";
        elLeadProduct.value = "";
        elLeadStatus.value = "Talked";
        elLeadDesc.value = "";
        elLeadTimestamps.textContent = "";
        elDeleteLeadBtn.classList.add('hidden');
      }
      elLeadModal.style.display = "flex";
      setTimeout(()=>elLeadName.focus(), 0);
    }
    function closeLeadModal(){ elLeadModal.style.display = "none"; }

    elSaveLeadBtn.addEventListener("click", ()=>{
      const name = (elLeadName.value||"").trim();
      const numbers = (elLeadNumbers.value||"").split(",").map(s=>s.trim()).filter(Boolean);
      const product = (elLeadProduct.value||"").trim();
      const status = elLeadStatus.value;
      const description = (elLeadDesc.value||"").trim();
      if (!name && numbers.length===0){ showToast('error','Enter name or at least one number'); return; }
      if (editingLeadId){
        const l = leads.find(x=>x.id===editingLeadId);
        if (!l) return;
        l.name = name; l.numbers = numbers; l.product = product; l.status = status; l.description = description;
        l.updatedAt = nowISO();
      }else{
        leads.push({ id: uuid(), name, numbers, product, status, description, createdAt: nowISO(), updatedAt: nowISO() });
      }
      saveAll();
      closeLeadModal();
      showToast('success','Lead saved');
    });
    elCancelLeadBtn.addEventListener("click", closeLeadModal);
    elDeleteLeadBtn.addEventListener("click", ()=>{
      if (!editingLeadId) return;
      if (!confirm('Delete this lead? This cannot be undone.')) return;
      const idx = leads.findIndex(x=>x.id===editingLeadId);
      if (idx!==-1) leads.splice(idx,1);
      saveAll();
      closeLeadModal();
      showToast('success','Lead deleted');
    });

    CT.openLeadAdd = ()=> openLeadModal(null);

    /* ===== Row interactions ===== */
    function cycleStatus(id){
      const t = tasks.find(x=>x.id===id); if(!t) return;
      const order = [STATUS.PENDING, STATUS.INPROG, STATUS.ONHOLD, STATUS.CANCELLED];
      let i = order.indexOf(t.status);
      if (i === -1) i = 0;
      t.status = order[(i+1) % order.length];
      t.updatedAt = nowISO();
      saveAll();
      showToast('success', 'Status: ' + t.status);
    }
    function cycleLeadStatus(id){
      const l = leads.find(x=>x.id===id); if(!l) return;
      const idx = LEAD_STATUS.indexOf(l.status);
      l.status = LEAD_STATUS[(idx+1) % LEAD_STATUS.length];
      l.updatedAt = nowISO();
      saveAll();
      showToast('success','Lead status: ' + l.status);
    }

    q("#activeList").addEventListener('click', (e)=>{
      const pill = e.target.closest('.status-pill');
      if (pill){ e.preventDefault(); e.stopPropagation(); cycleStatus(pill.getAttribute('data-id')); return; }
      const row = e.target.closest('.row[data-task-id]');
      if (row){ CT.editTask(row.dataset.taskId); }
    });
    q("#completedList").addEventListener('click', (e)=>{
      const row = e.target.closest('.row[data-task-id]');
      if (row){ CT.editTask(row.dataset.taskId); }
    });
    q("#leadsList").addEventListener('click', (e)=>{
      const pill = e.target.closest('.lead-status');
      if (pill){ e.preventDefault(); e.stopPropagation(); cycleLeadStatus(pill.getAttribute('data-id')); return; }
      const row = e.target.closest('.row[data-lead-id]');
      if (row){ openLeadModal(row.dataset.leadId); }
    });
    q("#addLeadBtn")?.addEventListener("click", ()=> openLeadModal(null));

    // Keyboard open on Enter
    ['#activeList', '#completedList', '#leadsList'].forEach(sel=>{
      const root = document.querySelector(sel);
      root.addEventListener('keydown', (e)=>{
        if (e.key !== 'Enter') return;
        const trow = e.target.closest('.row[data-task-id]');
        const lrow = e.target.closest('.row[data-lead-id]');
        if (trow) CT.editTask(trow.dataset.taskId);
        if (lrow) openLeadModal(lrow.dataset.leadId);
      });
    });

    /* ===== Export / Backup ===== */
    function csvFromRows(rows){
      return rows.map(r => r.map(cell => {
        const s = String(cell ?? "");
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(",")).join("\n");
    }
    async function downloadCSV(filename, rows){
      const csv = csvFromRows(rows);
      const blob = new Blob(["\uFEFF", csv], {type:"text/csv;charset=utf-8"});
      try{
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = filename; a.target = "_blank";
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
      }catch(e){
        console.error('download csv', e);
      }
    }
    function exportCSV(){
      try{
        const custRows = [["CustomerID","Customer Name","Mobile Numbers","Created At","Updated At"]];
        for(const c of customers){ custRows.push([c.id, c.name||"", (c.numbers||[]).join(", "), c.createdAt||"", c.updatedAt||""]); }

        const taskRows = [["TaskID","CustomerID","Customer Name","Mobile Numbers","Task Description","Due Date","Status","Created At","Updated At"]];
        for(const t of tasks){
          const c = customers.find(x=>x.id===t.customerId);
          taskRows.push([ t.id, t.customerId, c?(c.name||""):"", c?(c.numbers||[]).join(", "):"", t.description||"", t.dueDate||"", t.status||"", t.createdAt||"", t.updatedAt||"" ]);
        }

        const leadRows = [["LeadID","Customer Name","Mobile Numbers","Product","Status","Description","Created At","Updated At"]];
        for(const l of leads){
          leadRows.push([ l.id, l.name||"", (l.numbers||[]).join(", "), l.product||"", l.status||"", l.description||"", l.createdAt||"", l.updatedAt||"" ]);
        }

        downloadCSV("Customers.csv", custRows);
        setTimeout(()=>downloadCSV("Tasks.csv", taskRows), 400);
        setTimeout(()=>downloadCSV("Leads.csv", leadRows), 800);
        showToast('success','Export started');
      }catch(e){ console.error('export', e); showToast('error','Export failed'); }
    }
    function backupJSON(){
      const payload = { version:1, exportedAt: nowISO(), customers, tasks, leads };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'customer_tasks_backup.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
      showToast('success','Backup JSON downloaded');
    }
    CT.exportCSV = exportCSV;
    CT.backupJSON = backupJSON;

    /* ===== CSV Import (Customers / Tasks / Leads) ===== */
    function parseCSV(text){
      const rows = [];
      let cur = '', row = [], inQuotes = false;
      for (let i=0; i<text.length; i++){
        const c = text[i], n = text[i+1];
        if (inQuotes){
          if (c === '"' && n === '"'){ cur += '"'; i++; }
          else if (c === '"'){ inQuotes = false; }
          else { cur += c; }
        }else{
          if (c === '"'){ inQuotes = true; }
          else if (c === ','){ row.push(cur); cur = ''; }
          else if (c === '\n'){ row.push(cur); rows.push(row); row = []; cur = ''; }
          else if (c === '\r'){ }
          else { cur += c; }
        }
      }
      row.push(cur); rows.push(row);
      if (rows.length && rows[rows.length-1].every(x => String(x||'').trim()==='')) rows.pop();
      return rows;
    }
    function headerMap(headerRow){
      const map = {};
      headerRow.forEach((h,i)=> map[String(h||'').trim().toLowerCase()] = i);
      return map;
    }
    function getCell(row, hmap, aliases){
      for (const a of aliases){
        const idx = hmap[a.toLowerCase()];
        if (idx != null) return String(row[idx] ?? '').trim();
      }
      return '';
    }
    const splitNumbers = raw => (raw||'').split(',').map(s=>s.trim()).filter(Boolean);

    function findOrCreateCustomer({id, name, numbers}){
      let c = null;
      if (id) c = customers.find(x=>x.id===id) || null;
      if (!c && name) c = customers.find(x=>(x.name||'')===name) || null;
      if (!c && numbers && numbers.length){
        const flat = new Set(numbers);
        c = customers.find(x => (x.numbers||[]).some(m=> flat.has(m))) || null;
      }
      if (!c){
        c = { id: id||uuid(), name: name||'(Unnamed)', numbers: Array.isArray(numbers)?numbers:[], createdAt: nowISO(), updatedAt: nowISO() };
        customers.push(c);
        return { customer:c, created:true };
      }else{
        const exist = new Set((c.numbers||[]).map(x=>x.trim()).filter(Boolean));
        for (const n of (numbers||[])){ if(n && !exist.has(n)){ c.numbers.push(n); exist.add(n); } }
        c.updatedAt = nowISO();
        return { customer:c, created:false };
      }
    }
    function normTaskStatus(s){
      const x = String(s||'').toLowerCase();
      if (x.startsWith('pend')) return 'Pending';
      if (x.startsWith('in prog') || x==='ip') return 'In Progress';
      if (x.startsWith('on hol')) return 'On Hold';
      if (x.startsWith('cancel')) return 'Cancelled';
      if (x.startsWith('compl') || x==='done') return 'Completed';
      return 'Pending';
    }
    function normLeadStatus(s){
      const x = String(s||'').toLowerCase();
      if (x.startsWith('talk')) return 'Talked';
      if (x.startsWith('inter')) return 'Interested';
      if (x.startsWith('wait')) return 'Waiting Confirmation';
      if (x.startsWith('conv')) return 'Converted';
      return 'Talked';
    }

    function importCSV_Customers(rows){
      const headers = rows[0]; const data = rows.slice(1);
      const h = headerMap(headers);
      let added=0, updated=0;
      for (const r of data){
        if (!r || r.every(x => !String(x||'').trim())) continue;
        const id   = getCell(r,h,['customerid','id']);
        const name = getCell(r,h,['customer name','name']);
        const nums = splitNumbers(getCell(r,h,['mobile numbers','numbers','mobiles','phone','phones']));
        const res = findOrCreateCustomer({id,name,numbers:nums});
        if (res.created) added++; else updated++;
      }
      saveAll();
      showToast('success', `Customers CSV imported • Added ${added}, Updated ${updated}`);
    }
    function importCSV_Tasks(rows){
      const headers = rows[0]; const data = rows.slice(1);
      const h = headerMap(headers);
      let added=0, updated=0, createdCustomers=0;
      for (const r of data){
        if (!r || r.every(x => !String(x||'').trim())) continue;

        const taskId = getCell(r,h,['taskid','id']);
        const custId = getCell(r,h,['customerid','cust id']);
        const name   = getCell(r,h,['customer name','name']);
        const nums   = splitNumbers(getCell(r,h,['mobile numbers','numbers','mobiles','phone','phones']));
        const desc   = getCell(r,h,['task description','description','task']);
        const due    = getCell(r,h,['due date','due']);
        const status = normTaskStatus(getCell(r,h,['status']));

        const {customer, created} = findOrCreateCustomer({id:custId, name, numbers:nums});
        if (created) createdCustomers++;

        let t = taskId ? tasks.find(x=>x.id===taskId) : null;
        if (!t){
          tasks.push({ id: taskId||uuid(), customerId: customer.id, description: desc||'', dueDate: due||'', status, createdAt: nowISO(), updatedAt: nowISO() });
          added++;
        }else{
          t.customerId = customer.id;
          t.description = desc || t.description || '';
          t.dueDate = due || t.dueDate || '';
          t.status = status || t.status || 'Pending';
          t.updatedAt = nowISO();
          updated++;
        }
      }
      saveAll();
      showToast('success', `Tasks CSV imported • Added ${added}, Updated ${updated}${createdCustomers?` • New customers ${createdCustomers}`:''}`);
    }
    function importCSV_Leads(rows){
      const headers = rows[0]; const data = rows.slice(1);
      const h = headerMap(headers);
      let added=0, updated=0;
      const byId = new Map(leads.map(l=>[l.id,l]));
      for (const r of data){
        if (!r || r.every(x => !String(x||'').trim())) continue;

        const leadId = getCell(r,h,['leadid','id']);
        const name   = getCell(r,h,['customer name','name']);
        const nums   = splitNumbers(getCell(r,h,['mobile numbers','numbers','mobiles','phone','phones']));
        const prod   = getCell(r,h,['product']);
        const status = normLeadStatus(getCell(r,h,['status']));
        const desc   = getCell(r,h,['description','lead description','notes']);

        if (leadId && byId.has(leadId)){
          const l = byId.get(leadId);
          l.name = name || l.name || '(unnamed)';
          if (!Array.isArray(l.numbers)) l.numbers = [];
          const exist = new Set(l.numbers.map(x=>x.trim()).filter(Boolean));
          for (const n of nums){ if(n && !exist.has(n)){ l.numbers.push(n); exist.add(n); } }
          l.product = prod || l.product || '';
          l.status = status || l.status || 'Talked';
          l.description = (typeof desc==='string'?desc:'') || l.description || '';
          l.updatedAt = nowISO();
          updated++;
        }else{
          leads.push({ id: leadId||uuid(), name: name||'(unnamed)', numbers: nums, product: prod||'', status, description: (typeof desc==='string'?desc:''), createdAt: nowISO(), updatedAt: nowISO() });
          added++;
        }
      }
      saveAll();
      showToast('success', `Leads CSV imported • Added ${added}, Updated ${updated}`);
    }

    // Wire CSV inputs
    const csvBtn = q('#btnCsvUpload');
    const csvFile = q('#csvFile');
    const csvTarget = q('#csvTarget');
    csvBtn?.addEventListener('click', ()=> csvFile.click());
    csvFile?.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try{
        const text = await file.text();
        const rows = parseCSV(text);
        if (!rows.length){ showToast('error','CSV appears empty'); return; }
        const target = csvTarget.value || 'customers';
        if (target === 'customers') importCSV_Customers(rows);
        else if (target === 'tasks') importCSV_Tasks(rows);
        else importCSV_Leads(rows);
      }catch(err){
        console.error('CSV read error', err);
        showToast('error','Failed to read CSV');
      }finally{
        e.target.value = '';
      }
    });

    /* ===== Init ===== */
    // Leads filter buttons
    document.getElementById('addLeadBtn')?.addEventListener('click', ()=> CT.openLeadAdd());
    // Modal close buttons
    document.getElementById('cancelTaskBtn')?.addEventListener('click', ()=> { q('#taskModal').style.display = 'none'; });
    document.getElementById('cancelLeadBtn')?.addEventListener('click', ()=> { q('#leadModal').style.display = 'none'; });

    render();
  })();
  </script>
</body>
</html>
