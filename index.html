<script>
/* ========= CSV Targeted Import: Customers / Tasks / Leads ========= */
(function(){
  'use strict';
  // Ensure base app is loaded
  if (!window.CT || !window.localStorage){
    console.error('CSV module: CT not found. Include this after the main script.');
    return;
  }

  // Reuse from main app (fail-safe fallbacks)
  const nowISO = window.nowISO || (()=>new Date().toISOString());
  const uuid   = window.uuid   || (()=>crypto.randomUUID?.() || Math.random().toString(16).slice(2));
  const showToast = window.showToast || ((type,msg)=>alert(msg));
  const normalizeDigits = window.normalizeDigits || (s=>(s||'').replace(/[^\d]/g,''));

  // Storage references (live arrays from main app)
  let customers = window.localStorage ? JSON.parse(localStorage.getItem('ct_customers_v1')||'[]') : [];
  let tasks     = window.localStorage ? JSON.parse(localStorage.getItem('ct_tasks_v1')||'[]')     : [];
  let leads     = window.localStorage ? JSON.parse(localStorage.getItem('ct_leads_v1')||'[]')     : [];
  const saveAll = window.saveAll || function(){
    try{
      localStorage.setItem('ct_customers_v1', JSON.stringify(customers));
      localStorage.setItem('ct_tasks_v1', JSON.stringify(tasks));
      localStorage.setItem('ct_leads_v1', JSON.stringify(leads));
      if (window.CT && typeof CT === 'object' && typeof CT.__loaded !== 'undefined'){
        // Re-sync live references from main app if present
        customers = JSON.parse(localStorage.getItem('ct_customers_v1')||'[]');
        tasks     = JSON.parse(localStorage.getItem('ct_tasks_v1')||'[]');
        leads     = JSON.parse(localStorage.getItem('ct_leads_v1')||'[]');
        // Trigger UI render via main script if available
        if (typeof window.dispatchEvent === 'function'){
          // no-op; main script already calls render on saveAll()
        }
      }
    }catch(e){ console.error('CSV module saveAll', e); }
  };

  // ---- UI: inject dropdown + button + hidden input into the toolbar ----
  const toolbar = document.querySelector('.toolbar');
  if (toolbar){
    const sel = document.createElement('select');
    sel.id = 'csvTarget';
    sel.className = 'btn secondary';
    sel.style.padding = '9px 10px';
    sel.innerHTML = `
      <option value="customers">Upload CSV → Customers</option>
      <option value="tasks">Upload CSV → Tasks</option>
      <option value="leads">Upload CSV → Leads</option>`;
    const btn = document.createElement('button');
    btn.id = 'btnCsvUpload';
    btn.className = 'btn secondary';
    btn.textContent = 'Choose CSV';
    const fi = document.createElement('input');
    fi.id = 'csvFile';
    fi.type = 'file';
    fi.accept = '.csv,text/csv';
    fi.hidden = true;
    btn.addEventListener('click', ()=> fi.click());
    toolbar.appendChild(sel);
    toolbar.appendChild(btn);
    toolbar.appendChild(fi);

    fi.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try{
        const text = await file.text();
        const rows = parseCSV(text);
        if (!rows.length){ showToast('error','CSV appears empty'); e.target.value = ''; return; }
        const target = sel.value || 'customers';
        if (target === 'customers') importCSV_Customers(rows);
        else if (target === 'tasks') importCSV_Tasks(rows);
        else importCSV_Leads(rows);
      }catch(err){
        console.error('CSV read error', err);
        showToast('error','Failed to read CSV');
      }finally{
        e.target.value = '';
      }
    });
  }else{
    console.warn('CSV module: .toolbar not found — UI not injected.');
  }

  // ---- CSV parser (quotes, commas, CRLF) ----
  function parseCSV(text){
    const rows = [];
    let cur = '', row = [], inQuotes = false;
    for (let i=0; i<text.length; i++){
      const c = text[i], n = text[i+1];
      if (inQuotes){
        if (c === '"' && n === '"'){ cur += '"'; i++; }
        else if (c === '"'){ inQuotes = false; }
        else { cur += c; }
      }else{
        if (c === '"'){ inQuotes = true; }
        else if (c === ','){ row.push(cur); cur = ''; }
        else if (c === '\n'){ row.push(cur); rows.push(row); row = []; cur = ''; }
        else if (c === '\r'){ /* ignore CR; rely on \n */ }
        else { cur += c; }
      }
    }
    row.push(cur); rows.push(row);
    // Trim trailing blank row
    if (rows.length && rows[rows.length-1].every(x => String(x||'').trim() === '')) rows.pop();
    return rows;
  }
  function headerMap(headerRow){
    const map = {};
    headerRow.forEach((h,i)=>{ map[String(h||'').trim().toLowerCase()] = i; });
    return map;
  }
  function getCell(row, hmap, aliases){
    for (const a of aliases){
      const idx = hmap[a.toLowerCase()];
      if (idx != null) return String(row[idx] ?? '').trim();
    }
    return '';
  }
  const splitNumbers = raw => (raw||'').split(',').map(s=>s.trim()).filter(Boolean);

  // ---- Customer matching / creation ----
  function findOrCreateCustomer({id, name, numbers}){
    let c = null;
    if (id) c = customers.find(x=>x.id===id) || null;
    if (!c && name) c = customers.find(x=>(x.name||'')===name) || null;
    if (!c && numbers && numbers.length){
      const flat = new Set(numbers);
      c = customers.find(x => (x.numbers||[]).some(m=> flat.has(m))) || null;
    }
    if (!c){
      c = { id: id||uuid(), name: name||'(Unnamed)', numbers: Array.isArray(numbers)?numbers:[], createdAt: nowISO(), updatedAt: nowISO() };
      customers.push(c);
      return { customer:c, created:true };
    }else{
      // merge numbers
      const exist = new Set((c.numbers||[]).map(x=>x.trim()).filter(Boolean));
      for (const n of (numbers||[])){ if(n && !exist.has(n)){ c.numbers.push(n); exist.add(n); } }
      c.updatedAt = nowISO();
      return { customer:c, created:false };
    }
  }

  // ---- Status normalizers ----
  const TASK_STATUS = ['Pending','In Progress','On Hold','Cancelled','Completed'];
  function normTaskStatus(s){
    const x = String(s||'').toLowerCase();
    if (x.startsWith('pend')) return 'Pending';
    if (x.startsWith('in prog') || x==='ip') return 'In Progress';
    if (x.startsWith('on hol')) return 'On Hold';
    if (x.startsWith('cancel')) return 'Cancelled';
    if (x.startsWith('compl') || x==='done') return 'Completed';
    return 'Pending';
  }
  const LEAD_STATUS = ['Talked','Interested','Waiting Confirmation','Converted'];
  function normLeadStatus(s){
    const x = String(s||'').toLowerCase();
    if (x.startsWith('talk')) return 'Talked';
    if (x.startsWith('inter')) return 'Interested';
    if (x.startsWith('wait')) return 'Waiting Confirmation';
    if (x.startsWith('conv')) return 'Converted';
    return 'Talked';
  }

  // ---- Importers ----
  function importCSV_Customers(rows){
    const headers = rows[0]; const data = rows.slice(1);
    const h = headerMap(headers);
    let added=0, updated=0;
    for (const r of data){
      if (!r || r.every(x => !String(x||'').trim())) continue;
      const id   = getCell(r,h,['customerid','id']);
      const name = getCell(r,h,['customer name','name']);
      const nums = splitNumbers(getCell(r,h,['mobile numbers','numbers','mobiles','phone','phones']));
      const res = findOrCreateCustomer({id,name,numbers:nums});
      if (res.created) added++; else updated++;
    }
    saveAll();
    showToast('success', `Customers CSV imported • Added ${added}, Updated ${updated}`);
  }

  function importCSV_Tasks(rows){
    const headers = rows[0]; const data = rows.slice(1);
    const h = headerMap(headers);
    // Expected (flexible): TaskID, CustomerID, Customer Name, Mobile Numbers, Task Description, Due Date, Status
    let added=0, updated=0, createdCustomers=0;
    for (const r of data){
      if (!r || r.every(x => !String(x||'').trim())) continue;

      const taskId = getCell(r,h,['taskid','id']);
      const custId = getCell(r,h,['customerid','cust id']);
      const name   = getCell(r,h,['customer name','name']);
      const nums   = splitNumbers(getCell(r,h,['mobile numbers','numbers','mobiles','phone','phones']));
      const desc   = getCell(r,h,['task description','description','task']);
      const due    = getCell(r,h,['due date','due']);
      const stRaw  = getCell(r,h,['status']);
      const status = normTaskStatus(stRaw);

      const {customer, created} = findOrCreateCustomer({id:custId, name, numbers:nums});
      if (created) createdCustomers++;

      // Upsert by TaskID if present, else create new
      let t = taskId ? tasks.find(x=>x.id===taskId) : null;
      if (!t){
        tasks.push({
          id: taskId || uuid(),
          customerId: customer.id,
          description: desc || '',
          dueDate: due || '',
          status,
          createdAt: nowISO(),
          updatedAt: nowISO()
        });
        added++;
      }else{
        t.customerId = customer.id;
        t.description = desc || t.description || '';
        t.dueDate = due || t.dueDate || '';
        t.status = status || t.status || 'Pending';
        t.updatedAt = nowISO();
        updated++;
      }
    }
    saveAll();
    showToast('success', `Tasks CSV imported • Added ${added}, Updated ${updated}${createdCustomers?` • New customers ${createdCustomers}`:''}`);
  }

  function importCSV_Leads(rows){
    const headers = rows[0]; const data = rows.slice(1);
    const h = headerMap(headers);
    // Expected (flexible): LeadID, Customer Name, Mobile Numbers, Product, Status, Description
    let added=0, updated=0;
    const leadById = new Map(leads.map(l=>[l.id,l]));

    for (const r of data){
      if (!r || r.every(x => !String(x||'').trim())) continue;

      const leadId = getCell(r,h,['leadid','id']);
      const name   = getCell(r,h,['customer name','name']);
      const nums   = splitNumbers(getCell(r,h,['mobile numbers','numbers','mobiles','phone','phones']));
      const prod   = getCell(r,h,['product']);
      const stRaw  = getCell(r,h,['status']);
      const desc   = getCell(r,h,['description','lead description','notes']);
      const status = normLeadStatus(stRaw);

      if (leadId && leadById.has(leadId)){
        const l = leadById.get(leadId);
        l.name = name || l.name || '(unnamed)';
        if (!Array.isArray(l.numbers)) l.numbers = [];
        // merge numbers
        const exist = new Set(l.numbers.map(x=>x.trim()).filter(Boolean));
        for (const n of nums){ if(n && !exist.has(n)){ l.numbers.push(n); exist.add(n); } }
        l.product = prod || l.product || '';
        l.status = status || l.status || 'Talked';
        l.description = (typeof desc==='string'?desc:'') || l.description || '';
        l.updatedAt = nowISO();
        updated++;
      }else{
        leads.push({
          id: leadId || uuid(),
          name: name || '(unnamed)',
          numbers: nums,
          product: prod || '',
          status,
          description: (typeof desc==='string'?desc:''),
          createdAt: nowISO(),
          updatedAt: nowISO()
        });
        added++;
      }
    }
    saveAll();
    showToast('success', `Leads CSV imported • Added ${added}, Updated ${updated}`);
  }

})();
</script>
